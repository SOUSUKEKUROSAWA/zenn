---
title: "HTTPSにおける，非対称暗号法による鍵交換"
emoji: "🗝️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["非対称暗号法", "対称暗号法", "鍵交換", "HTTPS", "公開鍵認証"]
published: false
---
# ゴール
- HTTPSがどのように安全で高速な通信を実現しているかを理解する
![](https://storage.googleapis.com/zenn-user-upload/b73e260c8280-20230503.png)
上図を理解できるように説明します．
# 書いてあること
- HTTPSの簡単な説明
- 対称暗号法，非対称暗号法の概要
# 書いてないこと
- HTTPの基本に関する説明
- 暗号化の数学的説明
# HTTPS
HTTPS（Hyper Text Transfer Protocol Secure）．
名前の通り，HTTP＋Secureであり，インターネット上での安全な通信を確保するために使用される規約です．

Secureを実現するために，SSL(Secure Sockets Layer)/TLS(Transport Layer Security)（TLSはSSLの後継）というプロトコルを用いています．
TLSでは，非対称暗号法と対称暗号法という暗号化技術の両方を使用しています．

ここまでにでてきた色々な名前たちは，どうせ忘れるので覚えなくていいと思います．
# 対称暗号法のいいところ，わるいところ
まず，一般的に通信の暗号化というと，この対称暗号法を自然と思い浮かべる人が多いかもしれません．
以下に，図と通信手順を示します．[^1]
![](https://storage.googleapis.com/zenn-user-upload/39700a2a7db3-20230503.png)
1. リクエストを暗号化
2. リクエストを送信
3. リクエストを復号化
4. レスポンスを暗号化
5. レスポンスを送信
6. レスポンスを復号化

[^1]:αキーには対称暗号化キーという名前がついていますが，簡単のためにこの記事ではαキーと呼んでいます．

たしかに，これならシンプルに安全に通信ができそうです．
シンプルなので，高速に通信することができます．

ここで，なぜシンプルに安全に通信できているのかを考えてみたいと思います．

それは，クライアントとサーバで同じ鍵（暗号化／復号化のための暗号アルゴリズムに適した長さと構造を持つ文字列）を持っていて，かつ，外部からはこの鍵を推測，盗難，強制（外部から鍵を指定）できないからだと思います．

そのため，この通信を実現するためには，安全に鍵を交換する必要があります．

が，

対称暗号法では，鍵が1種類しかないので，この鍵を通信して直接渡すしかなく，この鍵が漏洩してした場合，安全な通信は実現できません．
# 非対称暗号法のいいところ，わるいところ
このため，HTTPSでは非対称暗号法を用いて，鍵交換を行います．
以下に，図と交換手順を示します．
![](https://storage.googleapis.com/zenn-user-upload/7553dbfe8d57-20230503.png)
0.公開鍵（Public key），秘密鍵（Private key）の生成[^2]
1. 公開鍵 in 証明書をクライアントに送信する
2. ランダムに生成されたαキーを公開鍵を用いて暗号化（α'キー）
3. α'キーをサーバへ送信
4. 秘密鍵を用いてα'キーを復号化（αキー）

[^2]:公開鍵と秘密鍵の生成はリクエストレスポンスのサイクル毎に行っているわけではなく，サーバがセットアップされるときに1度だけ生成されるので，手順0としています．（ただし，後述する証明書の有効期限が切れると，新しい証明書と共に新しい鍵ペアを生成することもあります．）

この手順を見ると鍵交換というより，鍵コピーに近いなと思いました．
これにより，クライアントとサーバにそれぞれ同じ鍵がある状態を安全に創り出すことができました．

ここで，なぜ安全に鍵交換を行えたのかを考えてみたいと思います．

それは，公開鍵によって生成された暗号化キー（α'キー）を公開鍵によって復号することが出来ないからだと思います．[^3]

[^3]:ちなみに，この公開鍵，秘密鍵の役割を逆にすることはできて，秘密鍵で生成した文字列を公開鍵で復号することによって，デジタル署名を実現していたりするみたいです（その署名を生成できるのは，秘密鍵を持っている人だけだから）．

これは，少し直感的ではないかもしれませんが，公開鍵は暗号化キーを生成することはできても，復号化することはできないような仕組みになっています．そして，秘密鍵だけが，その暗号化キーを復号することができます．[^4]

[^4]:こちらの仕組みに関しては，自分自身もよく知らないので，知っている方はぜひコメントで教えて頂けたらうれしいです．

さらに考えると，公開鍵がそのサーバのものであるという正当性も必須であることが分かります（悪意のあるサーバの公開鍵から暗号化キーを生成したら，悪意のあるサーバだけが通信メッセージを見ることができてしまうから）．

この正当性を証明するために用いられるのが，証明書です．証明書には以下の内容が含まれています．
- サーバの所有者情報（組織・ドメイン名）
- 公開鍵[^5]
- 証明書の有効期限
- 証明書の発行者（認証局）

[^5]:先ほど「公開鍵 in 証明書」としていたのはこのためです．

この中では，認証局というのが重要で，認証局は公開鍵とその配布者のリストを保守しています．また，公開鍵の配布者の身元検証（証明書申請者が申請内容に記載された情報[ドメイン名や組織名など]の正当な所有者であることを検証）なども行っています．
これにより，悪意のあるサーバからの公開鍵の強制を防いでいます．

要約すると，公開鍵と秘密鍵の役割分担，及び認証局による公開鍵の正当性の担保，この2つの前提条件が成立しているため，この方法で安全な鍵交換を行えます．

ただし，対称暗号法に比べてアルゴリズムが複雑なので，通信が遅くなってしまいます．
# まとめ
![](https://storage.googleapis.com/zenn-user-upload/b73e260c8280-20230503.png)
対称暗号法は，早いけど，鍵漏洩によるセキュリティリスクあり．
非対称暗号法は，遅いけど，安全な鍵交換を実現．

だから，

非対称暗号法を用いて，鍵交換を行い，対称暗号法を用いて，通信メッセージの暗号化・復号化を行うことにより，安全で高速な通信を実現しているのが，HTTPS．

それぞれのいいところを利用して，それぞれのわるいところを補っているんだなと感じました．
# 参考文献
- J. Glenn Brookshear 著、神林靖，長尾高弘 訳、[入門 コンピュータ科学 ITを支える技術と理論の基礎知識](https://www.kadokawa.co.jp/product/301702000130/)、株式会社ドワンゴ、2022。